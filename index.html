
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>USB MIDI CC Express BreathController ConfigurePage</title>
    <style>
      #content-body-wrapper {
        display: table;
        width: 100%;
      }
      #content-body {
        display: table-row;
      }  
      #primary, #secondary, #tertiary {
        display: table-cell;
        width: 33.33%;
      }
      #footer {
        height: 100px;
        padding-top: 40px;
      }
      body {
        color: #333;
        font-family: Helvetica Neue, Helvetica, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 0;
        text-align: center;
      }
      #incoming {
        overflow: auto;
        height: 300px;
      }  
      
    </style>
  </head>
  <body>
    <div id="header">
      <h1>USB MIDI CC Express BreathController ConfigurePage</h1>
    </div>
 
    <div id="content-body-wrapper">
      <div id="content-body">
        <div id="primary">
          <h2>Device</h2>
          <pre id="device"></pre>
        </div>
        <div id="secondary">
          <h2>Incoming messages</h2>
          <pre id="incoming">MIDI, CC NO., BreathValue</pre>
        </div>
        <div id="tertiary">
          <h2>Send Configure message</h2>
          <p>
            <br>Channel(1-16): <input value="1" id="msg1"/> 
            <br>NoteVolume(0-127): <input value="127" id="msg2"/>
            <br>FULL LEVEL(2000-32000): <input value="8191" id="msg3"/><!--SensorType 0=(2000-32000),1=(10-60),2=DN(10-60),3=LT(10-60),4=RT(5-35),5=(128-512) -->
            <br>CurveType(1-5): <input value="3" id="msg4"/>
            <br>SensorType <input value="0" id="msg5"/>	<!--0=BR,1=UP,2=DN,3=LT,4=RT ANGLE,5=LIP -->
            <br>MIDI CC A: <input value="0" id="msg6"/>	<!--MIDICCParam[0]-->
            <br>MIDI CC B: <input value="0" id="msg7"/>	<!--MIDICCParam[1]-->
            <br>MIDI CC C: <input value="11" id="msg8"/><!--MIDICCParam[2]-->
            <br>MIDI CC D: <input value="0" id="msg9"/>	<!--MIDICCParam[3]-->
            <br>Reserved <input value="65" id="msg10"/>	<!--MIDICCParam[4]-->
            <br>Reserved <input value="0" id="msg11"/>	<!--bmp280a.ctrl -->
            <br>Reserved <input value="7" id="msg12"/>	<!--bmp280a.ctrl -->
            <br>ZERO LEVEL(0-1500): <input value="200" id="msg13"/><!--SensorType 0=(0-1500),1=(0-5),2=(0-5),3=(0-5),4=(0-5) ANGLE,5=(0-16) -->
            <br><button onclick="rando()">Set&Write</button>
            <div id="err" style="color: red"></div>
          </p>
        </div>
      </div>
    </div>
     
    <div id="footer">
      <a href="https://www.bilibili.com/video/BV18Y411T7Ez/">Demo Video</a>
      <a href="https://item.taobao.com/item.htm?id=665187520848">Order Online</a>
      <a href="mailto://to_yue@hotmail.com">Other Question</a>
    </div>

<script>
function $(what) {
  return document.getElementById(what);
}
var O;
var I;
if (!('requestMIDIAccess' in navigator)) {
  $('content-body-wrapper').innerHTML = '<h3>Try the other browser of WebMIDI! </h3>';
} else {
  navigator.requestMIDIAccess().then(midi => {
    refresh(midi);
    midi.onstatechange = e => refresh(e.target);
  });
}



function refresh_backup(midi) {

  I = midi.inputs.size 
    ? midi.inputs.values().next().value
    : void(0);
  O = midi.outputs.size 
    ? midi.outputs.values().next().value
    : void(0);

  console.log(O);
  console.log(I);
  $('device').innerHTML = [
    'Output: ' + (O ? O.name : 'none'),
    '<br>Input: ' + (I ? I.name : 'none'),
  ].join('');

  if (I) {
    I.onmidimessage = msg => {
      const color = getColor();
      $('incoming').innerHTML += `<div style="color: ${color}">${msg.data}</div>`;
      $('incoming').scrollTop = $('incoming').scrollHeight; 
      $('footer').style.backgroundColor = color;
    };      
  }
  
  if (O) {
    err.innerHTML = '';
  }
}


function refresh(midi) {

var iteratori = midi.inputs.values();
var iteratoro = midi.outputs.values();
	//alert(midi.inputs.size);
for (var i = 0; i < midi.inputs.size; i++) {  
	I =iteratori.next().value;
	O =iteratoro.next().value;
	//alert(I.name);
	if("BreathController" == I.name)
	{
		//alert("OK");
		i = midi.inputs.size;
	}
	else
	{
		I = void(0);
		O = void(0);
	}
 }

  console.log(O);
  console.log(I);
  $('device').innerHTML = [
    'Output: ' + (O ? O.name : 'none'),
    '<br>Input: ' + (I ? I.name : 'none'),
  ].join('');

  if (I) {
    I.onmidimessage = msg => {
      const color = getColor();
      $('incoming').innerHTML += `<div style="color: ${color}">${msg.data}</div>`;
      $('incoming').scrollTop = $('incoming').scrollHeight; 
      $('footer').style.backgroundColor = color;
    };      
  }
  
  if (O) {
    err.innerHTML = '';
  }
}

function getColor() {
  return '#' + Math.floor(Math.random() * 16777215).toString(16);
}

function send(msg) {
  err.innerHTML = '';
  if (!O) {
    err.innerHTML = 'No connected devices to send a message to';
    return;
  }
  O.send(msg);
}

function rando() {

  err.innerHTML = '';
  try {
  	<!--	var cfgarry = newArray(3);cfgarry[0]="[0x9F]";cfgarry[1]="[2]";cfgarry[2]="[3]";-->
  	var msblsb; var msbflag;
  	var cfgarry = new Uint8Array(50+1);
  	cfgarry[0]=0x9F;cfgarry[1]=0x00;cfgarry[2]=0x00;
  	cfgarry[3]=0x9F;cfgarry[4]=(msg1.value-1);cfgarry[5]=0x01;	<!--Channel-->
  	cfgarry[6]=0x9F;cfgarry[7]=(msg2.value);cfgarry[8]=0x02;	<!--NoteVolume-->
  	
  	msblsb = msg3.value & 0xFF;									<!--FULL LEVEL-->
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[9]=0x9F;cfgarry[10]=msblsb;cfgarry[11]=(0x03|msbflag);
  	msblsb = (msg3.value/256) & 0xFF;
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[12]=0x9F;cfgarry[13]=msblsb;cfgarry[14]=(0x04|msbflag);
  	
  	cfgarry[15]=0x9F;cfgarry[16]=(msg4.value);cfgarry[17]=0x05;	<!--CurveType-->
  	
  	cfgarry[18]=0x9F;cfgarry[19]=(msg5.value);cfgarry[20]=0x06;	<!--SENSOR TYPE-->
  	
  	msblsb = msg6.value & 0xFF;									<!--MIDI CC A -->
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[21]=0x9F;cfgarry[22]=msblsb;cfgarry[23]=(0x07|msbflag);
  	
  	msblsb = msg7.value & 0xFF;									<!--MIDI CC B -->
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[24]=0x9F;cfgarry[25]=msblsb;cfgarry[26]=(0x08|msbflag);
  	
  	msblsb = msg8.value & 0xFF;									<!--MIDI CC C -->
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[27]=0x9F;cfgarry[28]=msblsb;cfgarry[29]=(0x09|msbflag);
  	
  	msblsb = msg9.value & 0xFF;									<!--MIDI CC D -->
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[30]=0x9F;cfgarry[31]=msblsb;cfgarry[32]=(0x0A|msbflag);
  	
  	msblsb = msg10.value & 0xFF;									<!--MIDI CC E-->
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[33]=0x9F;cfgarry[34]=msblsb;cfgarry[35]=(0x0B|msbflag);
  	
  	msblsb = msg11.value & 0xFF;									<!--bmp280a.config -->
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[36]=0x9F;cfgarry[37]=msblsb;cfgarry[38]=(0x0C|msbflag);
  	
  	msblsb = msg12.value & 0xFF;									<!--bmp280a.ctrl -->
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[39]=0x9F;cfgarry[40]=msblsb;cfgarry[41]=(0x0D|msbflag);
  	
  	msblsb = msg13.value & 0xFF;									<!--ZERO LEVEL-->
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[42]=0x9F;cfgarry[43]=msblsb;cfgarry[44]=(0x0E|msbflag);
  	msblsb = (msg13.value/256) & 0xFF;
  	if (msblsb>127) {msblsb=msblsb&0x7F;msbflag=0x40}
  	else msbflag = 0;
  	cfgarry[45]=0x9F;cfgarry[46]=msblsb;cfgarry[47]=(0x0F|msbflag);
  	
  	cfgarry[48]=0x8F;cfgarry[49]=0x7F;cfgarry[50]=0x5A;
  	
    <!--send(JSON.parse(msg1.value));-->
	send(cfgarry);
    <!--cfgarry.concat(msg2.value,msg3.value);-->
    
  } catch (e) {
    err.innerHTML = 'Failed,Try again.';
  }
}
</script>

  </body>
</html>
